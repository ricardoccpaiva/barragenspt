<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <%= csrf_meta_tag() %>
    <%= live_title_tag assigns[:page_title] || "Barragenspt" , suffix: " Â· Phoenix Framework" %>
      <link phx-track-static rel="stylesheet" href={Routes.static_path(@conn, "/assets/app.css" )} />
      <script defer phx-track-static type="text/javascript" src={Routes.static_path(@conn, "/assets/app.js" )}></script>
      <script src='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js'></script>
      <link href='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css' rel='stylesheet' />
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
<div class="container" style="margin-top: 10px;">
  <div class="is-primary">
    <nav class="navbar navbar_bck" role="navigation" aria-label="main navigation">
      <div class="navbar-brand navbar_bck">
        <a class="navbar-item" href="https://bulma.io">
          <img src="https://bulma.io/images/bulma-logo.png" width="112" height="28">
        </a>
        <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbarBasicExample">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>
      <div id="navbarBasicExample" class="navbar-menu">
        <div class="navbar-start">
          <a class="navbar-item" href="/">Home</a>
        </div>
      </div>
    </nav>
  </div>
</div>
<div class="container" style="margin-top: 10px">
  <div class="is-primary">
    <div class="columns">
      <div class="column">
        <div class="box" style="padding: 6px">
          <div id='map' style='height: 800px;' phx-update="ignore" phx-hook="PhoneNumber"></div>                  
        </div>    
      </div>
      <div class="column">
      <input id="mapbox_token" type="hidden" value={System.get_env("MAPBOX_API_TOKEN")}/> 
        <%= @inner_content %>
      </div>
    </div>
  </div>
</div>
</body>
<script>
  const loadDams = async () => {
    const response = await fetch('/dam_coords');
    const damsCoords = await response.json();
    damsCoords.data.forEach(function(element){
      el = document.createElement('div');                
      innerHTML = "<a style='color:  " + element.basin_color + "'";
      innerHTML = innerHTML + " class='fa fa-map-marker fa-2x' data-phx-link='patch'";
      innerHTML = innerHTML + " data-phx-link-state='push' href='/dam/" + element.id + "'</a>";
      el.innerHTML = innerHTML;

      new mapboxgl
        .Marker(el)
        .setLngLat([element.lon, element.lat])
        .addTo(map);
      });
    }
  
  mapboxgl.accessToken = document.getElementById("mapbox_token").value;
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/ricardoccpaiva/ckzcpwm4h001114mn112tg6fr',
    center: [-8, 39.69],
    zoom: 6
  });

  loadDams();
  
  map.addControl(new mapboxgl.NavigationControl());
</script>
</html>